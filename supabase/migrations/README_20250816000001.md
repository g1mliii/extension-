# Database Migration: API Compatibility Fix

## Migration: 20250816000001_fix_api_database_compatibility.sql

### Purpose
This migration ensures that all database functions, tables, views, and permissions required by the current API implementation are properly migrated and compatible.

### Issues Addressed

#### 1. Missing Table Columns
- Added `last_accessed` column to `ratings` table (referenced by API)
- Added `last_accessed` column to `url_stats` table (referenced by API)
- Added `phishtank_status` column to `domain_cache` table (may be referenced by domain analysis)

#### 2. Missing Views
- **Enhanced Trust Analytics**: The API expects to query `enhanced_trust_analytics` as a table, but it was replaced with a function in a previous migration. This migration recreates it as a view for API compatibility.
- **Trust Algorithm Performance**: Ensures the `trust_algorithm_performance` view exists and is accessible.

#### 3. Database Function Verification
The migration verifies that all required database functions exist:
- `batch_aggregate_ratings()` - Called by the 5-minute cron job
- `calculate_enhanced_trust_score()` - Used for trust score calculations
- `get_cache_statistics()` - Used by trust-admin API
- `update_trust_config()` - Used by trust-admin API
- `recalculate_with_new_config()` - Used by trust-admin API

#### 4. Cron Job Verification
- Ensures the `aggregate-ratings-job` cron job exists and runs every 5 minutes
- Creates the job if it's missing

#### 5. Permissions and Security
- Grants necessary permissions for API operations with RLS disabled
- Ensures `anon` role can read public data
- Ensures `authenticated` role can manage ratings
- Ensures `service_role` has full access (required for current API implementation)

#### 6. Performance Indexes
- Creates missing indexes for better query performance:
  - `idx_ratings_created_at` on `ratings(created_at)`
  - `idx_url_stats_last_accessed` on `url_stats(last_accessed)`
  - `idx_domain_cache_last_checked` on `domain_cache(last_checked)`

### API Functions Supported

This migration ensures compatibility with these API functions:

1. **url-trust-api** (main unified API)
   - GET /url-stats - Fetch URL statistics
   - POST /rating - Submit ratings

2. **batch-domain-analysis** 
   - POST / - Batch analyze domains

3. **aggregate-ratings**
   - POST / - Aggregate unprocessed ratings

4. **rating-submission**
   - POST / - Submit authenticated ratings

5. **trust-admin** (admin functions)
   - Various admin endpoints for configuration and analytics

### Database Tables Required

The migration verifies these tables exist:
- `ratings` - User ratings and reports
- `url_stats` - Aggregated URL statistics
- `domain_cache` - Cached domain analysis data
- `domain_blacklist` - Known malicious domains
- `content_type_rules` - Content-specific scoring rules
- `trust_algorithm_config` - Algorithm configuration

### Testing

The migration includes built-in tests that:
1. Verify all required tables exist
2. Verify all required functions exist
3. Test basic API database operations (insert/query)
4. Clean up test data

### Requirements Addressed

This migration addresses requirements 6.1-6.6:
- **6.1**: Rating aggregation and domain analysis background processing
- **6.2**: 5-minute cron job processing
- **6.3**: URL-specific and domain-level statistics updates
- **6.4**: Domain analysis cache checking
- **6.5**: Immediate user feedback without waiting for background processing
- **6.6**: Error logging and retry on next cron cycle

### Post-Migration Verification

After running this migration, verify:
1. All API endpoints return proper responses
2. Rating submission works correctly
3. URL statistics are retrieved successfully
4. Domain analysis is triggered appropriately
5. Cron job processes ratings every 5 minutes

### Notes

- This migration is designed to be safe and idempotent
- It uses `IF NOT EXISTS` and `IF EXISTS` clauses to avoid conflicts
- It includes comprehensive error checking and logging
- It maintains backward compatibility with existing data